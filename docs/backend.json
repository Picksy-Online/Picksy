{
  "entities": {
    "Product": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Product",
      "type": "object",
      "description": "Represents a product available for sale.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the product."
        },
        "name": {
          "type": "string",
          "description": "Name of the product."
        },
        "description": {
          "type": "string",
          "description": "Detailed description of the product."
        },
        "imageUrl": {
          "type": "string",
          "description": "URL of the product image.",
          "format": "uri"
        },
        "price": {
          "type": "number",
          "description": "Price of the product."
        },
        "categoryId": {
          "type": "string",
          "description": "Reference to Category. (Relationship: Category 1:N Product)"
        },
        "sellerId": {
          "type": "string",
          "description": "Reference to Seller. (Relationship: Seller 1:N Product)"
        },
        "moderationStatus": {
          "type": "string",
          "description": "The content moderation status of the product, i.e. 'approved', 'pending', 'rejected'."
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "imageUrl",
        "price",
        "categoryId",
        "sellerId",
        "moderationStatus"
      ]
    },
    "Category": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Category",
      "type": "object",
      "description": "Represents a category of products.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the category."
        },
        "name": {
          "type": "string",
          "description": "Name of the category."
        },
        "description": {
          "type": "string",
          "description": "Description of the category."
        },
        "imageUrl": {
          "type": "string",
          "description": "URL of the category image.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "imageUrl"
      ]
    },
    "Seller": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Seller",
      "type": "object",
      "description": "Represents a seller on the platform.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the seller."
        },
        "name": {
          "type": "string",
          "description": "Name of the seller."
        },
        "email": {
          "type": "string",
          "description": "Email address of the seller.",
          "format": "email"
        },
        "storeName": {
          "type": "string",
          "description": "The name of the seller's store."
        },
        "profileImageUrl": {
          "type": "string",
          "description": "URL of the seller's profile image.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "name",
        "email",
        "storeName",
        "profileImageUrl"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "username": {
          "type": "string",
          "description": "Username of the user."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "profileImageUrl": {
          "type": "string",
          "description": "URL of the user's profile image.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "username",
        "email"
      ]
    },
    "AiRecommendation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AiRecommendation",
      "type": "object",
      "description": "Represents a product recommendation generated by AI for a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the AI recommendation."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N AiRecommendation)"
        },
        "productId": {
          "type": "string",
          "description": "Reference to Product. (Relationship: Product 1:N AiRecommendation)"
        },
        "reason": {
          "type": "string",
          "description": "Reason for the recommendation (e.g., 'Based on your past purchases')."
        }
      },
      "required": [
        "id",
        "userId",
        "productId",
        "reason"
      ]
    },
    "Dispute": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Dispute",
      "type": "object",
      "description": "Represents a dispute or complaint filed by a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the dispute."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Dispute)"
        },
        "productId": {
          "type": "string",
          "description": "Reference to Product. (Relationship: Product 1:N Dispute)"
        },
        "reason": {
          "type": "string",
          "description": "Reason for the dispute."
        },
        "status": {
          "type": "string",
          "description": "Current status of the dispute (e.g., 'open', 'in progress', 'resolved')."
        },
        "resolution": {
          "type": "string",
          "description": "Resolution of the dispute."
        }
      },
      "required": [
        "id",
        "userId",
        "productId",
        "reason",
        "status"
      ]
    },
    "SalesAnalytic": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SalesAnalytic",
      "type": "object",
      "description": "Represents sales analytics data for sellers and admins.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the sales analytics data."
        },
        "sellerId": {
          "type": "string",
          "description": "Reference to Seller, if applicable. Nullable if it is admin data. (Relationship: Seller 1:N SalesAnalytic)"
        },
        "date": {
          "type": "string",
          "description": "The date for which the sales data is recorded.",
          "format": "date-time"
        },
        "totalSales": {
          "type": "number",
          "description": "Total sales amount for the given date."
        },
        "productViews": {
          "type": "number",
          "description": "Number of product views for the given date."
        }
      },
      "required": [
        "id",
        "date",
        "totalSales",
        "productViews"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/categories/{categoryId}",
        "definition": {
          "entityName": "Category",
          "schema": {
            "$ref": "#/backend/entities/Category"
          },
          "description": "Stores product categories. Only admins can create/modify. Includes category details.",
          "params": [
            {
              "name": "categoryId",
              "description": "Unique identifier for the category."
            }
          ]
        }
      },
      {
        "path": "/categories/{categoryId}/products/{productId}",
        "definition": {
          "entityName": "Product",
          "schema": {
            "$ref": "#/backend/entities/Product"
          },
          "description": "Subcollection containing products belonging to a specific category. Includes denormalized 'categoryId' for efficient querying and authorization.",
          "params": [
            {
              "name": "categoryId",
              "description": "Unique identifier for the category."
            },
            {
              "name": "productId",
              "description": "Unique identifier for the product."
            }
          ]
        }
      },
      {
        "path": "/sellers/{sellerId}",
        "definition": {
          "entityName": "Seller",
          "schema": {
            "$ref": "#/backend/entities/Seller"
          },
          "description": "Stores seller profiles. Includes seller's contact and store information.",
          "params": [
            {
              "name": "sellerId",
              "description": "Unique identifier for the seller."
            }
          ]
        }
      },
      {
        "path": "/sellers/{sellerId}/products/{productId}",
        "definition": {
          "entityName": "Product",
          "schema": {
            "$ref": "#/backend/entities/Product"
          },
          "description": "Subcollection containing products listed by a specific seller. Includes denormalized 'sellerId' for efficient querying and authorization.",
          "params": [
            {
              "name": "sellerId",
              "description": "Unique identifier for the seller."
            },
            {
              "name": "productId",
              "description": "Unique identifier for the product."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles. Includes user's basic information.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/ai_recommendations/{aiRecommendationId}",
        "definition": {
          "entityName": "AiRecommendation",
          "schema": {
            "$ref": "#/backend/entities/AiRecommendation"
          },
          "description": "Subcollection containing AI-generated product recommendations for a specific user. Includes denormalized 'userId' for ownership.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            },
            {
              "name": "aiRecommendationId",
              "description": "Unique identifier for the AI recommendation."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/disputes/{disputeId}",
        "definition": {
          "entityName": "Dispute",
          "schema": {
            "$ref": "#/backend/entities/Dispute"
          },
          "description": "Subcollection containing disputes filed by a specific user. Includes denormalized 'userId' for ownership.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            },
            {
              "name": "disputeId",
              "description": "Unique identifier for the dispute."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Documents in this collection indicate admin role. Existence of a document determines admin status.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/sales_analytics_admin/{salesAnalyticsId}",
        "definition": {
          "entityName": "SalesAnalytic",
          "schema": {
            "$ref": "#/backend/entities/SalesAnalytic"
          },
          "description": "Collection for admin sales analytics. 'sellerId' is null.",
          "params": [
            {
              "name": "salesAnalyticsId",
              "description": "Unique identifier for the sales analytics data."
            }
          ]
        }
      },
      {
        "path": "/sellers/{sellerId}/sales_analytics/{salesAnalyticsId}",
        "definition": {
          "entityName": "SalesAnalytic",
          "schema": {
            "$ref": "#/backend/entities/SalesAnalytic"
          },
          "description": "Sales analytics data specific to a seller.  Includes denormalized 'sellerId'.",
          "params": [
            {
              "name": "sellerId",
              "description": "Unique identifier for the seller."
            },
            {
              "name": "salesAnalyticsId",
              "description": "Unique identifier for the sales analytics data."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support Picksy's core features, focusing on security, scalability, and ease of debugging. The design prioritizes authorization independence through denormalization, enabling robust security rules and atomic operations. Structural segregation ensures a homogeneous security posture for each collection, simplifying rule management.\n\n**Authorization Independence (CRITICAL):** To avoid hierarchical authorization dependencies, key authorization data is denormalized. For example, product documents include the `sellerId` to avoid needing to fetch the Seller document to authorize product-related operations.\n\n**Structural Segregation:** Data with differing access requirements are stored in separate collections. User-specific data (like disputes) are stored under the `/users/{userId}` path, while global data (like categories) reside in top-level collections.\n\n**Access Modeling:** Ownership is explicitly modeled. User-owned data utilizes path-based ownership (`/users/{userId}/disputes/{disputeId}`), making ownership clear and enforceable. Product data includes `sellerId` to ensure that only the seller can update the products. Categories are available to everyone but can only be created/edited by Admins (using `/roles_admin/{userId}` to check for admin role). Sales analytics is split in two collections: `/sales_analytics_admin` for admins, and `/sellers/{sellerId}/sales_analytics` for the seller.\n\n**QAPs (Rules are not Filters):** The structure facilitates secure `list` operations. For example, listing products for a specific category is supported by the `/categories/{categoryId}/products/{productId}` subcollection, ensuring that only products belonging to the category are listed. Admin disputes are separate to avoid any leaking of info to sellers.\n\n**DBAC (No Custom Claims):** Admin rights are managed via the `/roles_admin/{userId}` collection.\n\n**Invariants:** Timestamps (if added) and denormalized data should be managed via server-side functions to ensure data integrity."
  }
}